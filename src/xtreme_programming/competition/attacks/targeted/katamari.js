/*
Copyright Alex Leone, David Nufer, David Truong, 2011-03-11. kathack.com

javascript:var i,s,ss=['http://kathack.com/js/kh.js','http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js'];for(i=0;i!=ss.length;i++){s=document.createElement('script');s.src=ss[i];document.body.appendChild(s);}void(0);

*/
if (!!!window.kotamari_started){
  window.kotamari_started = true;
  function getCssTransform(){var t,e,o=document.createElement("div");for(t=0;t<POSSIBLE_TRANSFORM_PREFIXES.length;t++)if(e=POSSIBLE_TRANSFORM_PREFIXES[t],o.style.setProperty(e+"transform","rotate(1rad) scaleX(2)",null),o.style.getPropertyValue(e+"transform"))return CSS_TRANSFORM=e+"transform",void(CSS_TRANSFORM_ORIGIN=e+"transform-origin");throw alert("Your browser doesn't support CSS tranforms!"),"Your browser doesn't support CSS tranforms!"}function circleGridObjInt(t,e,o,n,i){var a,l;return t<i.left?(a=i.left-t,e<i.top?(l=i.top-e,n>=a*a+l*l):e<=i.bottom?o>=a:(l=e-i.bottom,n>=a*a+l*l)):t<=i.right?e<i.top?i.top-e<=o:e<=i.bottom?!0:e-i.bottom<=o:(a=t-i.right,e<i.top?(l=i.top-e,n>=a*a+l*l):e<=i.bottom?o>=a:(l=e-i.bottom,n>=a*a+l*l))}function getClosestPoint(t,e,o){var n;return t<o.left?(n=o.left-t,e<o.top?[o.left,o.top]:e<=o.bottom?[o.left,e]:[o.left,o.bottom]):t<=o.right?e<o.top?[t,o.top]:e<=o.bottom?[t,e]:[t,o.bottom]:(n=t-o.right,e<o.top?[o.right,o.top]:e<=o.bottom?[o.right,e]:[o.right,o.bottom])}function gridObjVol(t){return t.w*t.h*Math.min(t.w,t.h)}function StickyNodes(){function t(t){void 0!==t&&null!==t&&(t.khIgnore=!0,t.style.border=BORDER_STYLE,o.push(t))}function e(t){var e;for(e=0;e<t.arrs.length;e++)t.arrs[e][t.idxs[e]]=void 0;t.el.style.visibility="hidden",t.el.khPicked=!0,delete t.arrs,delete t.idxs}var o=[],n=[],i=100,a=100,l={a:1,b:1,big:1,body:1,cite:1,code:1,dd:1,div:1,dt:1,em:1,font:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,i:1,label:1,legend:1,li:1,p:1,pre:1,small:1,span:1,strong:1,sub:1,sup:1,td:1,th:1,tt:1};this.addDomNode=t,this.addWords=function(e){function o(t){return t.tagName&&l[t.tagName.toLowerCase()]}function n(t,e){var i,l;if(e&&t.nodeType===Node.TEXT_NODE&&t.nodeValue.trim().length>0)return void a.push(t);if(t.childNodes&&!t.khIgnore)for(e=o(t),i=0,l=t.childNodes.length;l>i;i++)n(t.childNodes[i],e)}function i(e){var o,n,i=e.parentNode,a=e.nodeValue.split(/\s+/),l=e.nodeValue.split(/\S+/),r=Math.max(a.length,l.length);for(l.length>0&&0===l[0].length&&l.shift(),o=0;r>o;o++)o<a.length&&a[o].length>0&&(n=document.createElement("span"),n.innerHTML=a[o],i.insertBefore(n,e),t(n)),o<l.length&&l[o].length>0&&(n=document.createTextNode(l[o]),i.insertBefore(n,e));i.removeChild(e)}var a=[];n(e,o(e)),a.map(i)},this.addTagNames=function(e,o){var n,i,a,l,r=e.tagName&&e.tagName.toLowerCase();if(!e.khIgnore&&(-1!==o.indexOf(r)&&t(e),e.getElementsByTagName))for(n=0;n<o.length;n++)for(a=e.getElementsByTagName(o[n]),i=0,l=a.length;l>i;i++)a[i].khIgnore||t(a[i])},this.finalize=function(t,e){var l,r,s,c,d,h,u,f,p,m,g,v=Math.floor(t/i)+1,b=Math.floor(e/a)+1;for(n=new Array(v),l=0;v>l;l++)n[l]=new Array(b);for(s=0,c=o.length;c>s;s++)if(u=o[s],!u.khPicked)for(p=jQuery(u).offset(),m=jQuery(u).width(),g=jQuery(u).height(),f={el:o[s],left:p.left,right:p.left+m,top:p.top,bottom:p.top+g,w:m,h:g,x:p.left+m/2,y:p.top+g/2,diag:Math.sqrt((m*m+g*g)/4),arrs:[],idxs:[]},d=Math.floor(f.left/i),h=Math.floor(f.top/a),v=Math.floor((f.left+f.w)/i)+1,b=Math.floor((f.top+f.h)/a)+1,l=d;v>l;l++)for(r=h;b>r;r++)void 0===n[l]&&(n[l]=[]),void 0===n[l][r]?n[l][r]=[f]:n[l][r].push(f),f.arrs.push(n[l][r]),f.idxs.push(n[l][r].length-1)},this.removeIntersecting=function(t,o,l,r){var s,c,d,h,u,f=l*l,p=Math.floor((t-l)/i),m=Math.floor((o-l)/a),g=Math.floor((t+l)/i)+1,v=Math.floor((o+l)/a)+1;for(s=p;g>s;s++)if(void 0!==n[s])for(c=m;v>c;c++)if(d=n[s][c],void 0!==d)for(h=0;h<d.length;h++)u=d[h],void 0!==u&&circleGridObjInt(t,o,l,f,u)&&r(u)&&e(u)}}function PlayerBall(t,e,o,n){function i(){return 4*Math.PI*b*b*b/3}function a(t){var e=i()+gridObjVol(t)*E;b=Math.pow(3*e/(4*Math.PI),1/3)}function l(t){var e=getClosestPoint(p,m,t),o=e[0]-p,i=e[1]-m,l=Math.sqrt(o*o+i*i),r=0-N,s=e[0]-t.left,c=e[1]-t.top,d=Math.atan2(i,o)-N,u=l*Math.cos(d),f=l*Math.sin(d),g=t.el.cloneNode(!0),v=jQuery(t.el),b={el:g,attX:u,attY:f,attT:"translate("+Math.round(u)+"px,"+Math.round(f)+"px) rotate("+r+"rad)",r:l,offTh:d,offPhi:0-O,diag:t.diag,removeR:l+t.diag,visible:!1,display:v.css("display")};k.push(b),a(t),g.style.position="absolute",g.style.left=-s+"px",g.style.top=-c+"px",g.style.setProperty(CSS_TRANSFORM_ORIGIN,s+"px "+c+"px",null),g.style.display="none",g.style.color=v.css("color"),g.style.textDecoration=v.css("text-decoration"),g.style.fontSize=v.css("font-size"),g.style.fontWeight=v.css("font-weight"),g.khIgnore=!0,h.appendChild(g),n&&n.play_pop()}function r(t){return C&&gridObjVol(t)>i()?!1:(l(t),!0)}function s(){var t,e,o,n,i,a,l,r,s,c,d;for(u.style.left=p-b+"px",u.style.top=m-b+"px",b!=y&&(u.width=2*b+1,u.height=2*b+1,y=b),f.clearRect(0,0,2*b,2*b),f.fillStyle="#fff",f.beginPath(),f.arc(b,b,b-1,0,2*Math.PI,!0),f.fill(),f.strokeStyle=w,f.beginPath(),f.arc(b,b,b-1,0,2*Math.PI,!0),f.stroke(),f.fillStyle=w,t=b+b*Math.cos(N+Math.PI/16),e=b+b*Math.sin(N+Math.PI/16),o=b+b*Math.cos(N-Math.PI/16),n=b+b*Math.sin(N-Math.PI/16),i=b+b*Math.cos(N+15*Math.PI/16)-t,a=b+b*Math.sin(N+15*Math.PI/16)-e,l=0;l<2*Math.PI;l+=Math.PI/7)r=(-Math.cos(O+l)+1)/2,s=(-Math.cos(O+l+Math.PI/32)+1)/2,c=Math.sin(O+l),d=Math.sin(O+l+Math.PI/32),c>0&&d>0&&(f.beginPath(),f.moveTo(t+r*i,e+r*a),f.lineTo(t+s*i,e+s*a),f.lineTo(o+s*i,n+s*a),f.lineTo(o+r*i,n+r*a),f.fill())}function c(t){var e=N+t.offTh,o=O+t.offPhi,n=t.r*Math.cos(e),i=t.r*Math.sin(e),a=t.r*Math.cos(N-t.offTh+Math.PI)-n,l=t.r*Math.sin(N-t.offTh+Math.PI)-i,r=(-Math.cos(o)+1)/2,s=n+r*a,c=i+r*l,d=t.r*Math.sin(o);return 0>d&&Math.sqrt(s*s+c*c)+t.diag<b?(t.visible&&(t.visible=!1,t.el.style.display="none"),!1):(t.visible||(t.visible=!0,t.el.style.display=t.display),t.el.style.zIndex=d>0?501:499,t.el.style.setProperty(CSS_TRANSFORM,"translate("+p+"px,"+m+"px) rotate("+N+"rad) scaleX("+Math.cos(o)+") "+t.attT,null),!0)}function d(t){h.removeChild(t.el),delete t.el}var h,u,f,p=300,m=300,g=0,v=0,b=20,y=0,M=1e4,S=1e4,k=[],w=o.color,T=0,x=0,I=!1,E=o.VOL_MULT,P=o.MAX_ATTACHED_VISIBLE,C=o.CHECK_VOLS,N=0,O=0;this.init=function(){u=document.createElement("canvas"),u.width=2*b,u.height=2*b,u.style.cssText="position: absolute; z-index: 500;",t.appendChild(u),f=u.getContext("2d"),h=document.createElement("div"),t.appendChild(h)},this.setRadius=function(t){b=t},this.getState=function(){return{x:p,y:m,vx:g,vy:v,radius:b,th:N,phi:O}},this.setState=function(t){p=t.x,m=t.y,g=t.vx,v=t.vy,b=t.radius,N=t.th,O=t.phi},this.setXY=function(t,e){p=t,m=e},this.setTh=function(t){N=t},this.setPhi=function(t){O=t},this.setColor=function(t){w=t},this.setDocSize=function(t,e){M=t,S=e},this.setAccel=function(t){I=t},this.setAccelTarget=function(t,e){T=t,x=e},this.updatePhysics=function(){var t,o,i,a=p,l=m,s=!1;I?(i=Math.atan2(x-m,T-p),g+=.5*Math.cos(i),v+=.5*Math.sin(i)):(g*=.95,v*=.95),p+=g,m+=v,0>p-b?(s=!0,p=b+1,g=-g):p+b>M&&(s=!0,p=M-b-1,g=-g),0>m-b?(s=!0,m=b+1,v=-v):m+b>S&&(s=!0,m=S-b-1,v=-v),(0!==g||0!==v)&&(N=Math.atan2(v,g),t=p-a,o=m-l,O-=Math.sqrt(t*t+o*o)/b),e.removeIntersecting(p,m,b,r),this.draw(),s&&n&&n.play_bounce()},this.draw=function(){var t,e,o=0;for(s(),t=k.length;--t>=0;)if(e=k[t],e.removeR<b)k.splice(t,1).map(d);else if(c(e)&&++o>P){k.splice(0,t).map(d);break}}}function preventDefault(t){return t.preventDefault(),t.returnValue=!1,!1}function Game(t,e,o){function n(){i.setDocSize(jQuery(document).width()-5,jQuery(document).height()-5)}var e,i,a,l;i=new PlayerBall(t,e,o,!1),i.init(),i.setXY(300,300),window.scrollTo(0,200),n(),document.addEventListener("touchstart",function(t){return 1===t.touches.length?(i.setAccel(!0),preventDefault(t)):void 0},!0),document.addEventListener("touchmove",function(t){i.setAccelTarget(t.touches[0].pageX,t.touches[0].pageY)},!0),document.addEventListener("touchend",function(t){return 0===t.touches.length?(i.setAccel(!1),preventDefault(t)):void 0},!0),-5!==o.MOUSEB&&(document.addEventListener("mousemove",function(t){i.setAccelTarget(t.pageX,t.pageY)},!0),document.addEventListener("mousedown",function(t){return t.button===o.MOUSEB?(i.setAccel(!0),preventDefault(t)):void 0},!0),document.addEventListener("mouseup",function(t){return t.button===o.MOUSEB?(setTimeout(function(){i.setAccel(!1)},500),preventDefault(t)):void 0},!0),0===o.MOUSEB?document.addEventListener("click",function(t){return 0===t.button?preventDefault(t):void 0},!0):2===o.MOUSEB&&document.addEventListener("contextmenu",preventDefault,!0)),a=setInterval(function(){i.updatePhysics()},25),l=setInterval(n,1e3)}function whenAllLoaded(t,e,o){o.finalize(jQuery(document).width(),jQuery(document).height()),jQuery("#loadingp").empty(),setTimeout(function(){var n,i,a;jQuery("#bgmusicc").attr("checked")&&((i=document.getElementById("khbgmusic"))||(i=document.createElement("audio"),i.id="khbgmusic",i.loop="loop",i.src="http://kathack.com/js/katamari.mp3",t.appendChild(i)),i.play()),a={color:"#7D26CD",VOL_MULT:1,MAX_ATTACHED_VISIBLE:75,CHECK_VOLS:!1,MOUSEB:0},t.removeChild(e),n=new Game(t,o,a)},150).appendTo("#loadingp")}function buildPopup(t){var e=document.createElement("div");return e.style.cssText="position: fixed;left: 50%;top: 50%;width: 400px;margin-left:-200px;margin-top:-150px;border:1px solid black;background-color:white;color:black;padding:20px;font-size:13px;text-align:left;z-index:501;",e.innerHTML='<h1 style="font-size:16pt"><a href="http://kathack.com/" style="color:blue;text-decoration:none;">Katamari!</a></h1><button style="position:absolute;top:0;right:0;">X</button><p>Controls: Hold down <b><select id="mouseb"><option value="0">Left-Click</option><option value="2" selected="selected">Right-Click</option><option value="-5">Touch</option></select></b> to control the ball!</p><div><label>Background Music? <input id="bgmusicc" type="checkbox" checked="checked" /></label></div><div style="text-align:right; color:gray;"><label>Katamari Color: <select id="khcolor"><option value="#ff0000" style="background-color:#ff0000;color:#ff0000"> r </option><option value="#00ff00" style="background-color:#00ff00;color:#00ff00"> g </option><option value="#0000ff" style="background-color:#0000ff;color:#0000ff"> b </option><option selected="selected" value="#7D26CD" style="background-color:#7D26CD;color:#7D26CD"> p </option></select></label><br /> <label title="Lower this if the game gets slow.">Max Attached Objects: <select id="maxAtt"><option>25</option><option>50</option><option selected="selected">75</option><option>100</option><option>9000</option></select></label><br /><label title="How much to grow when an object is picked up.">Growth Speed: <input id="vol_mult" type="text" size="6" value="1.0" /></label><br /><label title="Bigger objects require a bigger katamari to pick up.">Realistic Pickups? <input id="checkv" type="checkbox" checked="checked" /></label></div><p id="loadingp">Loading!</p>',t.appendChild(e),e.getElementsByTagName("button")[0].addEventListener("click",function(){t.removeChild(e)},!0),e}function main(){var t,e,o;t=document.createElement("div"),t.khIgnore=!0,document.body.appendChild(t),o=buildPopup(t),setTimeout(function(){var n,i,a;for(window.khNodes.addWords(document.body),n=0,i=document.body.childNodes.length;i>n;n++)a=document.body.childNodes[n],window.khNodes.addTagNames(a,["button","canvas","iframe","img","input","select","textarea"]);e=setInterval(function(){window.jQuery&&(clearInterval(e),whenAllLoaded(t,o,window.khNodes))},100)},0)}var BORDER_STYLE="1px solid #bbb",CSS_TRANSFORM=null,CSS_TRANSFORM_ORIGIN=null,POSSIBLE_TRANSFORM_PREFIXES=["-webkit-","-moz-","-o-","-ms-",""],khFirst=!1;window.khNodes||(khFirst=!0,window.khNodes=new StickyNodes),getCssTransform(),window.noMain||main();
}
